---
platform: linux
image_resource:
  type: registry-image
  source:
    # Use GCC image which includes sanitizer runtime libraries
    repository: ((repository))
    tag: ((tag))
inputs:
  - name: submission
  - name: upstream-output
    optional: true
  - name: assignment-assets
  - name: ghost
outputs:
  - name: execution-output
params:
  EXECUTION_BINARY: ((execution_binary))
  EXECUTION_FLAGS: ((execution_flags))
  INPUT_PATH: ((input_path))
  OUTPUT_PATH: ((output_path))
  STDERR_PATH: ((stderr_path))
  SCORE: ((score))
  # Sanitizer-specific parameters
  ASAN_OPTIONS: ((asan_options))
  UBSAN_OPTIONS: ((ubsan_options))
  TSAN_OPTIONS: ((tsan_options))
run:
  path: bash
  args:
    - -c
    - |
      # Make ghost executable
      chmod +x ghost/ghost-linux-amd64
      
      # Set sanitizer options if provided
      if [ -n "${ASAN_OPTIONS}" ]; then
        export ASAN_OPTIONS="${ASAN_OPTIONS}"
        echo "üõ°Ô∏è AddressSanitizer options: ${ASAN_OPTIONS}"
      fi
      
      if [ -n "${UBSAN_OPTIONS}" ]; then
        export UBSAN_OPTIONS="${UBSAN_OPTIONS}"
        echo "üõ°Ô∏è UBSan options: ${UBSAN_OPTIONS}"
      fi
      
      if [ -n "${TSAN_OPTIONS}" ]; then
        export TSAN_OPTIONS="${TSAN_OPTIONS}"
        echo "üõ°Ô∏è ThreadSanitizer options: ${TSAN_OPTIONS}"
      fi
      
      # Execute with ghost
      ./ghost/ghost-linux-amd64 run --verbose \
        -i "${INPUT_PATH}" \
        -o "execution-output/${OUTPUT_PATH}:${OUTPUT_PATH}" \
        -e "execution-output/${STDERR_PATH}:${STDERR_PATH}" \
        --score "${SCORE}" \
        --upload-provider "minio" \
        -- ${EXECUTION_BINARY} ${EXECUTION_FLAGS}