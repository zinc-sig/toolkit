platform: linux
image_resource:
  type: registry-image
  source:
    repository: busybox
inputs:
  - name: submission
  - name: upstream-output
    optional: true
  - name: assignment-assets
  - name: ghost
outputs:
  - name: testing-output
params:
  INPUT_PATH: ((input_path))
  EXPECTED_PATH: ((expected_path))
  OUTPUT_PATH: ((output_path))
  STDERR_PATH: ((stderr_path))
  SCORE: ((score))
  DIFF_FLAGS: ((diff_flags))
run:
  path: sh
  args:
    - -c
    - |
      # Detect architecture and set ghost binary path
      # Maps x86_64 -> amd64, aarch64 -> arm64
      GHOST_ARCH=$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/')
      GHOST_BIN="ghost/ghost-linux-${GHOST_ARCH}"
      chmod +x "$GHOST_BIN"

      # Run ghost diff command
      # Note: OUTPUT_PATH and STDERR_PATH should now be simple filenames or relative paths
      # as they will be uploaded directly to the configured bucket location
      "$GHOST_BIN" diff --verbose \
        -i "${INPUT_PATH}" \
        -x "${EXPECTED_PATH}" \
        -o "testing-output/${OUTPUT_PATH}:${OUTPUT_PATH}" \
        -e "testing-output/${STDERR_PATH}:${STDERR_PATH}" \
        --score "${SCORE}" \
        --diff-flags "${DIFF_FLAGS}" \
        --upload-provider "minio"
