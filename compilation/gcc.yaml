platform: linux
image_resource:
  type: registry-image
  source:
    repository: gcc
    tag: latest
inputs:
  - name: submission
  - name: assignment-assets
outputs:
  - name: compilation-output
params:
  SOURCE_FILE: ((source_file))
  OUTPUT_BINARY: ((output_binary))
  COMPILER_FLAGS: ((compiler_flags))
  LANGUAGE: ((language))
run:
  path: bash
  args:
    - '-c'
    - |
      # Determine compiler based on language
      if [ "${LANGUAGE}" = "cpp" ] || [ "${LANGUAGE}" = "c++" ]; then
        COMPILER="g++"
      else
        COMPILER="gcc"
      fi

      # Compile with ghost
      ghost run --verbose \
        -i /dev/null \
        -o compilation-output/compile.log \
        -e compilation-output/compile.err \
        -- ${COMPILER} ${COMPILER_FLAGS} "submission/${SOURCE_FILE}" -o "compilation-output/${OUTPUT_BINARY}"

      # Make the binary executable if compilation succeeded
      if [ $? -eq 0 ]; then
        chmod +x "compilation-output/${OUTPUT_BINARY}"
      fi
