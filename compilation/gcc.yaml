platform: linux
image_resource:
  type: registry-image
  source:
    repository: gcc
    tag: ((version))
inputs:
  - name: submission
  - name: upstream-output
    optional: true
  - name: assignment-assets
  - name: ghost
outputs:
  - name: compilation-output
params:
  SOURCE_FILE: ((source_file))
  OUTPUT_BINARY: ((output_binary))
  COMPILER_FLAGS: ((compiler_flags))
  LANGUAGE: ((language))
  SCORE: ((score))
run:
  path: bash
  args:
    - '-c'
    - |
      # Detect architecture and set ghost binary path
      # Maps x86_64 -> amd64, aarch64 -> arm64
      GHOST_ARCH=$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/')
      GHOST_BIN="ghost/ghost-linux-${GHOST_ARCH}"
      chmod +x "$GHOST_BIN"

      # Determine compiler based on language
      if [ "${LANGUAGE}" = "cpp" ] || [ "${LANGUAGE}" = "c++" ]; then
        COMPILER="g++"
      else
        COMPILER="gcc"
      fi

      # Compile with ghost
      "$GHOST_BIN" run --verbose \
        -i /dev/null \
        -o compile.log \
        -e compile.err \
        --score "${SCORE}" \
        --upload-provider "minio" \
        --upload-files "compilation-output/${OUTPUT_BINARY}:${OUTPUT_BINARY}" \
        -- ${COMPILER} ${COMPILER_FLAGS} "${SOURCE_FILE}" -o "compilation-output/${OUTPUT_BINARY}"
